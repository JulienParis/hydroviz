

<div id="map" style="position: fixed;"></div>


<script>

  // CREATE EMPTY LAYERS GROUPS
  var water_layer    = new L.layerGroup();
  var admin_layer    = new L.layerGroup();
  var stations_layer = new L.layerGroup();

  // BASEMAP TILES
  var mbAttr =
    'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
    '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
    'Imagery <a href="http://mapbox.com">Mapbox</a>';
  var mbUrl  = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';

  var grayscale  = L.tileLayer(mbUrl, {id: 'mapbox.light'  , attribution: mbAttr});
  var streets    = L.tileLayer(mbUrl, {id: 'mapbox.streets', attribution: mbAttr});

  // LEAFLET MAP OBJECT
  var map = L.map('map', {
    center: [47, 3],
    zoom: 6,
    layers: [ grayscale, water_layer, admin_layer ]
  });


  // CREATE CONTROLS
  var baseLayers = {
    "Grayscale": grayscale,
    "Streets"  : streets
  };

  var overlays = {
    "admin layer"    : admin_layer,
    "water layer"    : water_layer,
    "stations layer" : stations_layer
  };

  var controls = L.control.layers(baseLayers, overlays, { position:"topleft" } ).addTo(map);


  // TOPOJSON HANDLING
  L.TopoJSON = L.GeoJSON.extend({
    addData: function(jsonData) {
      if (jsonData.type === "Topology") {
        for (key in jsonData.objects) {
          geojson = topojson.feature(jsonData, jsonData.objects[key]);
          L.GeoJSON.prototype.addData.call(this, geojson);
        }
      }
      else {
        L.GeoJSON.prototype.addData.call(this, jsonData);
      }
    }
  }); // Copyright (c) 2013 Ryan Clark

  var topoLayer_water    = new L.TopoJSON();
  var topoLayer_admin    = new L.TopoJSON();
  var topoLayer_stations = new L.TopoJSON();



  // DEFER FUNCTION TO PRELOAD STUFF ...
  // queue()
  //   .defer(d3.json, "{{ url_for( 'static', filename='data/carto_web/departements.json' ) }}" )
  //   .defer(d3.json, "{{ url_for( 'static', filename='data/carto_web/departements.json' ) }}" )
  //   .await(addTopoData);


  // TO DO : ADD SOCKET IO FUNCTIONS HERE
  $.getJSON( "{{ url_for( 'static', filename='data/carto_web/departements.json' ) }}" )
    .done(addTopoData_admin);

  $.getJSON( "{{ url_for( 'static', filename='data/carto_web/ME_014_030_060.json' ) }}" )
    .done(addTopoData_water);

  // $.getJSON( "{{ url_for( 'static', filename='data/carto_web/stations_web_carto_topo.json' ) }}" )
  //   .done(addTopoData_stations);

  // WARNING : OVERWRITES previous TOPOLAYER object
  function addTopoData_admin(topoData){
    topoLayer_admin.addData(topoData);
    topoLayer_admin.addTo(admin_layer);
  };

  function addTopoData_water(topoData){
    topoLayer_water.addData(topoData);
    topoLayer_water.addTo(water_layer);
  };


  // function addTopoData_stations(topoData){
  //   topoLayer_water.addData(topoData);
  //   topoLayer_water.addTo(stations_layer);
  // };

</script>
